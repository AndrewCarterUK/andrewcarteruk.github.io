<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />

        <title>Breaking Boundaries with FastCGI - Andrew Carter</title>
        <meta name="description" content="How to turbocharge PHP using FastCGI" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />

        <link rel="stylesheet" type="text/css" href="css/reveal.css" />
        <link rel="stylesheet" type="text/css" href="css/theme/league.css" />
        <link rel="stylesheet" type="text/css" href="lib/css/zenburn.css" />

        <!--[if lt IE 9]>
            <script type="text/javascript" src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="reveal">
            <div style="position: absolute; top: 1em; left: 1em; text-align: left; font-size: 0.5em;">
                Breaking Boundaries with FastCGI - Andrew Carter
            </div>
            <div style="position: absolute; top: 1em; right: 1em; text-align: right; font-size: 0.5em;">
                @AndrewCarterUK
            </div>
            <div class="slides">
                <section><h1>Breaking Boundaries with FastCGI</h1></section>
                <section>
                    <h2>HTTP pipeline <span data-fragment-index="1" class="fragment">- as a restaurant</span></h2>
                    <table>
                        <tr>
                            <th>Client</th>
                            <td><img data-fragment-index="2" class="fragment icon inline-icon" src="images/customer.png" /></td>
                            <td><span data-fragment-index="2" class="fragment">Customer</span></td>
                        </tr>
                        <tr>
                            <th>Server</th>
                            <td><img data-fragment-index="3" class="fragment icon inline-icon" src="images/restaurant.png" /></td>
                            <td><span data-fragment-index="3" class="fragment">Restaurant</span></td>
                        </tr>
                        <tr>
                            <th>Request</th>
                            <td><img data-fragment-index="4" class="fragment icon inline-icon" src="images/order.png" /></td>
                            <td><span data-fragment-index="4" class="fragment">Order</span></td>
                        </tr>
                        <tr>
                            <th>Response</th>
                            <td><img data-fragment-index="5" class="fragment icon inline-icon" src="images/food.png" /></td>
                            <td><span data-fragment-index="5" class="fragment">Food</span></td>
                        </tr>
                        <tr>
                            <th>Application</th>
                            <td><img data-fragment-index="6" class="fragment icon inline-icon" src="images/chef.png" /></td>
                            <td><span data-fragment-index="6" class="fragment">Chef</span></td>
                        </tr>
                        <tr>
                            <th>Application Interface</th>
                            <td><img data-fragment-index="7" class="fragment icon inline-icon" src="images/waitress.png" /></td>
                            <td><span data-fragment-index="7" class="fragment">Waiter/Waitress</span></td>
                        </tr>
                        <tr><td colspan="3"></td></tr>
                    </table>
                </section>
                <section>
                    <h2>If PHP were a restaurant...</h2>
                    <table>
                        <tr class="fragment">
                            <td><img class="icon inline-icon" src="images/customer.png" /></td>
                            <td>Customer enters restaurant</td>
                            <td><img class="icon inline-icon" src="images/restaurant.png" /></td>
                        </tr>
                        <tr class="fragment">
                            <td><img class="icon inline-icon" src="images/waitress.png" /></td>
                            <td>Waitress takes order</td>
                            <td>
                                <img class="icon inline-icon" src="images/order.png" />
                            </td>
                        </tr>
                        <tr class="fragment">
                            <td><img class="icon inline-icon" src="images/waitress.png" /></td>
                            <td>Waitress <b>creates chef</b> and gives order</td>
                            <td>
                                <img class="icon inline-icon" src="images/chef.png" />
                            </td>
                        </tr>
                        <tr class="fragment">
                            <td><img class="icon inline-icon" src="images/chef.png" /></td>
                            <td>Chef makes food</td>
                            <td>
                                <img class="icon inline-icon" src="images/food.png" />
                            </td>
                        </tr>
                        <tr class="fragment">
                            <td><img class="icon inline-icon" src="images/food.png" /></td>
                            <td>Waitress gives food to customer</td>
                            <td>
                                <img class="icon inline-icon" src="images/customer.png" />
                            </td>
                        </tr>
                        <tr class="fragment">
                            <td><img class="icon inline-icon" src="images/waitress.png" /></td>
                            <td>Waitress <b>brutally murders</b> chef</td>
                            <td>
                                <img class="icon inline-icon" src="images/dead-chef.png" />
                            </td>
                        </tr>
                        <tr><td colspan="2"></td></tr>
                    </table>
                </section>
                <section>
                    <h2>The proposal?</h2>
                    <br />
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/chef.png" /><br />
                        Don&apos;t kill the chef
                    </p>
                </section>
                <section>
                    <p>But how?</p>
                </section>
                <section>
                    <h2>CGI: Common Gateway Interface</h2>
                </section>
                <section>
                    <p>HTTP request provided via <b>environment variables</b></p>
                </section>
                <section>
                    <p>HTTP response written to <b>standard output</b> by application</p>
                </section>
                <section>
                    <p>Application must be executable by the web server</p>
                </section>
                <section>
                    <p>One instance of our application per request</p>
                </section>
                <section>
                    <p>Back in the day...</p>
                    <p class="fragment">when I was 3</p>
                    <p class="fragment">PHP was just a set of CGI binaries</p>
                </section>
                <section>
                    <p>We can still integrate PHP using CGI</p>
                </section>
                <section>
                    <p>We can also use native web server modules</p>
                </section>
                <section>
                    <p>We can also use PHP-FPM</p>
                </section>
                <section>
                    <h2>PHP-FPM?</h2>
                    <p class="fragment">PHP FastCGI Process manager</p>
                </section>
                <section>
                    <h2>FastCGI?</h2>
                    <p class="fragment">Like CGI... but faster</p>
                </section>
                <section>
                    <h2>How can we make CGI faster?</h2>
                    <p class="fragment">Wrap our communication in a protocol</p>
                    <p class="fragment">Implement this protocol over a socket connection</p>
                    <p class="fragment">Keep our application alive between requests!</p>
                </section>
                <section>
                    <h2>PHP-FPM</h2>
                    <p>Keeps the <b>PHP interpreter</b> alive between requests</p>
                </section>
                <section>
                    <p>
                        <img class="icon inline-icon" src="images/dead-chef.png" /><br />
                        We are <b>still killing</b> our chef
                    </p>
                </section>
                <section>
                    <h2>Use FastCGI directly?</h2>
                </section>
                <section>
                    <h2>With a legacy application?</h2>
					<pre><code data-trim>
include 'lib/common.php';
include 'lib/database.php';

$escaped_url = mysql_real_escape_string($_SERVER['REQUEST_URI']);

$result = mysql_query(
    'SELECT html ' .
    'FROM pages ' .
    'WHERE url=\'' . $escaped_url . '\''
);

if (false === $result || !($page = mysql_fetch_assoc($result))) {
    header('HTTP/1.1 404 Not Found');
    $page = get_404_page();
}

echo $page['html'];
					</code></pre>
                </section>
                <section>
                    <h2>With Symfony?</h2>
                    <pre><code data-trim>
use Symfony\Component\ClassLoader\ApcClassLoader;
use Symfony\Component\HttpFoundation\Request;

$loader = require_once __DIR__.'/../app/bootstrap.php.cache';

require_once __DIR__.'/../app/AppKernel.php';

$kernel = new AppKernel('prod', false);
$kernel->loadClassCache();

$request = Request::createFromGlobals();
$response = $kernel->handle($request);
$response->send();
$kernel->terminate($request, $response);
                    </code></pre>
                </section>
                <section>
                    <h2>The FastCGI protocol</h2>
                    <table style="font-size: 0.6em;">
                        <tr><td>-&gt;</td><td>FCGI_BEGIN_REQUEST</td></tr>
                        <tr><td>-&gt;</td><td>FCGI_PARAMS</td></tr>
                        <tr><td>-&gt;</td><td>FCGI_PARAMS</td></tr>
                        <tr><td>-&gt;</td><td>...</td></tr>
                        <tr><td>-&gt;</td><td>FCGI_STDIN</td></tr>
                        <tr><td>-&gt;</td><td>FCGI_STDIN</td></tr>
                        <tr><td>-&gt;</td><td>...</td></tr>
                        <tr><td></td><td>FCGI_STDOUT</td><td>&lt;-</td></tr>
                        <tr><td></td><td>FCGI_STDOUT</td><td>&lt;-</td></tr>
                        <tr><td></td><td>...</td><td>&lt;-</td></tr>
                        <tr><td></td><td>FCGI_END_REQUEST</td><td>&lt;-</td></tr>
                    </table>
                </section>
                <section>
                    <h2>Binary protocol</h2>
                    <p>
					    <pre style="display: inline;"><code style="display: inline;" data-trim>
                            pack() unpack()
                        </code></pre>
                    </p>
                </section>
                <section>
                    <p>Or...</p>
                </section>
                <section>
                    <h2>PHPFastCGI</h2>
                </section>
                <section>
					<pre><code data-trim>
use PHPFastCGI\FastCGIDaemon\ApplicationFactory;
use PHPFastCGI\FastCGIDaemon\Http\RequestInterface;
use Zend\Diactoros\Response\HtmlResponse;

// A simple kernel. This is the core of your application
$kernel = function (RequestInterface $request) {
    // $request->getServerRequest()         PSR-7 object
    // $request->getHttpFoundationRequest() HTTP foundation object
    return new HtmlResponse('<h1>Hello, World!</h1>');
};

// Create your Symfony console application using the factory
$application = (new ApplicationFactory)->createApplication($kernel);

// Run the Symfony console application
$application->run();
					</code></pre>
                </section>
                <section>
                    <p>
                        <img class="icon inline-icon" src="images/restaurant.png" /><br />
                        Back to the restaurant
                    </p>
                </section>
                <section>
                    <p>
                        <img class="icon inline-icon" src="images/chef.png" /><br />
                        No more chef killing
                    </p>
                </section>
                <section>
                    <h2>Problem</h2>
                    <p class="fragment">What if our chef gets ill?</p>
                </section>
                <section>
                    <h2>Solution #1</h2>
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/dead-chef.png" /><br />
                        Kill the chef before they get ill
                    </p>
                </section>
                <section>
                    <h2>Solution #2</h2>
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/gordon-ramsay.jpg" /><br />
                        Use a better chef
                    </p>
                </section>
                <section>
                    <h2>Memory Meltdown</h2>
                    <br />
                    <p class="fragment">
                        Chef never forgets some of the meals they have made
                    </p>
                    <p class="fragment">
                        Chef can only remember so much
                    </p>
                    <p class="fragment">
                        Chef's head explodes
                    </p>
                    <br />
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/dead-chef.png" />
                    </p>
                </section>
                <section>
                    <p>Remove references to unrequired objects</p>
                </section>
                <section>
                    <h2>Timeouts</h2>
                    <br />
                    <p class="fragment">
                        Chef forgets how to use oven after a couple of hours
                    </p>
                    <p class="fragment">
                        Chef needs oven
                    </p>
                    <br />
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/dead-chef.png" />
                    </p>
                </section>
                <section>
                    <p>ERROR 2006: MySQL server has gone away</p>
                </section>
                <section>
                    <h2>Tantrum Handling</h2>
                    </p>
                    <br />
                    <p class="fragment">
                        Chef encounters minor issue
                    </p>
                    <p class="fragment">
                        Chef throws big tantrum
                    </p>
                    <br />
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/dead-chef.png" />
                    </p>
                </section>
                <section>
                    <p>Recover all possible errors</p>
                </section>
                <section>
                    <p>Let the application die if recovery is not possible</p>
                </section>
                <section>
                    <h2>Evil Customer</h2>
                    <br />
                    <p class="fragment">
                        Chef brainwashed by evil customer
                    </p>
                    <p class="fragment">
                        Chef tricked into poisoning other customers
                    </p>
                    <br />
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/dead-chef.png" />
                    </p>
                </section>
                <section>
                    <p>Avoid static and global memory</p>
                </section>
                <section>
                    <h2>Chef Upgrade</h2>
                    <br />
                    <p class="fragment">
                        Restaurant owner wants Chef with new recipes
                    </p>
                    <p class="fragment">
                        Chef is pretty set in their ways
                    </p>
                    <p class="fragment">
                        Restaurant owner forgets to kill old Chef
                    </p>
                    <p class="fragment">
                        Chef keeps serving up old recipes
                    </p>
                    <br />
                    <p class="fragment">
                        <img class="icon inline-icon" src="images/dead-chef.png" />
                    </p>
                </section>
                <section>
                    <p>Remember to kill old Chef(s)</p>
                </section>
                <section>
                    <p>Leaving behind our restaurant...</p>
                </section>
                <section>
                    <h2>Benchmarking Application</h2>
                    <p class="fragment">500 page Symfony application</p>
                    <p class="fragment">Single route which selects a random page from database</p>
                    <p class="fragment">Renders using Twig</p>
                    <p class="fragment">Clears entity repository after each request</p>
                </section>
                <section>
                    <h2>Benchmarking System</h2>
                    <p class="fragment">VMWare Fusion - 2GB RAM - 4 cores (Intel Core i7, 3.4 GHz)</p>
                    <p class="fragment">Ubuntu 64-bit Server 15.04</p>
                    <p class="fragment">PHP 5.6.4</p>
                    <p class="fragment">NGINX</p>
                    <p class="fragment">'ab', 50000 requests, concurrency level of 20</p>
                </section>
                <section>
                    <h2>For the control</h2>
                    <p class="fragment">OPcache enabled</p>
                    <p class="fragment">PHP-FPM</p>
                </section>
                <section>
                    <h2>For the test</h2>
                    <p class="fragment">6 worker processes</p>
                </section>
                <section>
                    <h2>The results</h2>
                    <br />
                    <img src="images/results.png" style="width: 80%;" alt="Results graph" />
                </section>
                <section>
                    <p>To conclude...</h2>
                </section>
                <section>
                    <p>FastCGI is designed to allow applications to stay alive between requests</p>
                </section>
                <section>
                    <p>PHP is <small><s>not</s></small> designed to allow applications to stay alive between requests</p>
                </section>
                <section>
                    <p>That is possibly why no one has made a serious effort to do this</p>
                </section>
                <section>
                    <p>Used carefully, this can break performance boundaries</p>
                </section>
                <section>
                    <p>Thank you for listening</p>
                    <br />
                    <p>Any questions?</p>
                    <br />
                    <p><b>@AndrewCarterUK</b></p>
                    <br />
                    <p>http://phpfastcgi.github.io<br />http://github.com/PHPFastCGI/SpeedfonyBundle</p>
                </section>
            </div>
        </div>

        <script type="text/javascript" src="lib/js/head.min.js"></script>
        <script type="text/javascript" src="js/reveal.js"></script>
        <script type="text/javascript">
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,
                transition: 'none',
                dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/notes/notes.js', async: true }
                ]
            });
        </script>
    </body>
</html>
